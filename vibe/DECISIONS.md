# AI Novel Studio - 技术决策记录

> 记录开发过程中的重要技术决策，便于回溯和保持一致性

---

## 决策格式

每条决策包含：
- **日期**: 决策时间
- **问题**: 面临的选择
- **决策**: 最终选择
- **原因**: 为什么这样选
- **影响**: 对项目的影响

---

## 已确定的决策 (来自 PRD)

### D001: 前端框架选择
- **日期**: 2026-01-03 (PRD 定稿)
- **问题**: React 生态中选择哪个框架？
- **决策**: Next.js 15 (App Router)
- **原因**: 
  - App Router 支持 Server Components，首屏性能好
  - 内置 API Routes，无需单独后端
  - Vercel 部署体验最佳
- **影响**: 路由使用文件系统约定，需要学习 App Router 模式

### D002: 状态管理方案
- **日期**: 2026-01-03 (PRD 定稿)
- **问题**: 全局状态 vs 服务端状态如何管理？
- **决策**: Zustand (全局) + TanStack Query (服务端)
- **原因**:
  - Zustand 轻量，API 简洁
  - TanStack Query 自带缓存、乐观更新、离线支持
  - 职责分离清晰
- **影响**: 需要区分哪些状态放 Zustand，哪些用 Query

### D003: 数据库选择
- **日期**: 2026-01-03 (PRD 定稿)
- **问题**: 使用什么数据库？
- **决策**: Supabase (PostgreSQL + pgvector)
- **原因**:
  - 免费额度足够个人项目
  - 内置 Auth、Realtime、Storage
  - pgvector 支持向量检索
  - RLS 提供行级安全
- **影响**: 需要学习 Supabase 特有的 API 和 RLS 语法

### D004: ORM 选择
- **日期**: 2026-01-03 (PRD 定稿)
- **问题**: 直接用 Supabase Client 还是 ORM？
- **决策**: Drizzle ORM (常规表) + Supabase Client (Vector)
- **原因**:
  - Drizzle 类型安全，Schema 即代码
  - Drizzle 对 pgvector 支持有限，Vector 操作用原生 Client
- **影响**: 两套数据访问方式，需要统一封装

### D005: 编辑器选择
- **日期**: 2026-01-03 (PRD 定稿)
- **问题**: 使用什么富文本编辑器？
- **决策**: Tiptap
- **原因**:
  - Headless 架构，完全可定制
  - 支持 Markdown 快捷键
  - 扩展系统强大，可实现实体高亮
  - 社区活跃
- **影响**: 需要自己实现 UI，但灵活性高

### D006: 拖拽排序算法
- **日期**: 2026-01-03 (PRD 定稿)
- **问题**: 如何处理无限层级的拖拽排序？
- **决策**: Fractional Indexing
- **原因**:
  - 插入时只需更新单条记录的 order
  - 避免批量更新所有兄弟节点
  - 适合乐观更新场景
- **影响**: order 字段为 String 类型，需要使用 `fractional-indexing` 库

### D007: 实体高亮算法
- **日期**: 2026-01-03 (PRD 定稿)
- **问题**: 如何高效匹配多个实体名称？
- **决策**: Aho-Corasick 算法 + Web Worker
- **原因**:
  - Aho-Corasick 可一次扫描匹配所有关键词
  - Web Worker 避免阻塞主线程
  - 实体上限 200 个，性能可控
- **影响**: 需要引入 AC 算法库或自行实现

### D008: Mentions 表简化
- **日期**: 2026-01-03 (PRD 定稿)
- **问题**: 是否存储实体在文本中的精确位置？
- **决策**: 只存储 frequency，不存储 positions
- **原因**:
  - 位置偏移量在编辑时需频繁重算，成本高
  - 高亮已在前端实时计算
  - 频次足够用于排序和 AI 上下文选择
- **影响**: 无法实现"点击实体跳转到引用处"功能

### D009: 版本历史策略
- **日期**: 2026-01-03 (PRD 定稿)
- **问题**: 何时创建版本快照？
- **决策**: 手动保存或切换节点时，间隔 5 分钟 + 变化 200 字符
- **原因**:
  - 避免自动保存导致版本爆炸
  - 控制存储成本
  - 20 版本上限足够回溯
- **影响**: 用户需要主动保存才能创建版本

### D010: 离线存储方案
- **日期**: 2026-01-03 (PRD 定稿)
- **问题**: 离线时数据存在哪里？
- **决策**: IndexedDB (via idb-keyval)
- **原因**:
  - 浏览器原生支持
  - idb-keyval 封装简洁
  - 容量足够存储操作队列
- **影响**: 需要实现离线队列和同步逻辑

---

## 开发过程中的决策

> 以下为开发过程中新增的决策，按时间顺序记录

<!-- 
### D0XX: 决策标题
- **日期**: YYYY-MM-DD
- **问题**: 
- **决策**: 
- **原因**: 
- **影响**: 
-->

---

## 待决策事项

> 开发中遇到需要决策的问题，先记录在此

- [ ] AI Provider 优先级：OpenAI vs DeepSeek vs Anthropic
- [ ] 图片存储：Supabase Storage vs 外部 CDN
- [ ] 是否需要 PWA 支持（MVP 阶段）

---

## 决策变更记录

> 如果之前的决策需要修改，在此记录

<!-- 
### D001 变更
- **原决策**: xxx
- **新决策**: xxx
- **变更原因**: xxx
- **变更日期**: YYYY-MM-DD
-->
